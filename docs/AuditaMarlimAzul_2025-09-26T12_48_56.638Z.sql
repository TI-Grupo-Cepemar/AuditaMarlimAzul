CREATE TABLE "gerentes" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"nome" VARCHAR NOT NULL UNIQUE,
	"regional" BOOLEAN NOT NULL,
	"email" VARCHAR NOT NULL CHECK(email ~ '^.+@.+(.com(.br)?)$'),
	PRIMARY KEY("id")
);




CREATE TABLE "bases" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"sigla" VARCHAR(10) NOT NULL,
	"id_gerente" INTEGER NOT NULL,
	"id_gerente_regional" INTEGER NOT NULL,
	"id_municipio" INTEGER NOT NULL,
	PRIMARY KEY("id")
);




CREATE TABLE "municipios" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"nome" VARCHAR NOT NULL,
	"id_estado" INTEGER NOT NULL,
	PRIMARY KEY("id")
);




CREATE TABLE "estados" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"nome" VARCHAR NOT NULL,
	"uf" CHAR(2) NOT NULL,
	PRIMARY KEY("id")
);




CREATE TABLE "auditorias" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"id_base" INTEGER NOT NULL,
	"data_inicial" DATE NOT NULL,
	"data_final" DATE NOT NULL,
	"pre_auditoria" BOOLEAN NOT NULL DEFAULT FALSE,
	PRIMARY KEY("id")
);




CREATE TABLE "topicos" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"id_auditoria" INTEGER NOT NULL,
	"id_classificacao" INTEGER NOT NULL,
	"id_status" INTEGER NOT NULL,
	"descricao" VARCHAR NOT NULL,
	"id_grupo_responsavel" INTEGER NOT NULL,
	"id_area_atuacao" INTEGER NOT NULL,
	"id_questionamento" INTEGER NOT NULL,
	PRIMARY KEY("id")
);




CREATE TABLE "classificacoes" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"nome" VARCHAR NOT NULL,
	PRIMARY KEY("id")
);




CREATE TABLE "questionamentos" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"codigo" INTEGER NOT NULL,
	"descricao" VARCHAR NOT NULL,
	"id_gravidade" INTEGER NOT NULL,
	"id_elemento" CHAR(1) NOT NULL,
	PRIMARY KEY("id")
);




CREATE TABLE "elementos" (
	"id" CHAR(1) NOT NULL UNIQUE CHECK(id ~ '^[A-Z]+$'),
	"nome" VARCHAR NOT NULL,
	"id_modelo" INTEGER NOT NULL,
	PRIMARY KEY("id")
);




CREATE TABLE "modelos" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"nome" VARCHAR NOT NULL,
	PRIMARY KEY("id")
);




CREATE TABLE "gravidades" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"nome" VARCHAR NOT NULL,
	"peso" INTEGER NOT NULL,
	"coloracao" VARCHAR(6) NOT NULL,
	PRIMARY KEY("id")
);




CREATE TABLE "questionamentos_normas" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"id_questionamento" INTEGER NOT NULL,
	"id_norma" INTEGER NOT NULL,
	PRIMARY KEY("id")
);




CREATE TABLE "normas" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"nome" VARCHAR NOT NULL,
	"descricao" VARCHAR NOT NULL,
	PRIMARY KEY("id")
);




CREATE TABLE "usuarios" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"nome" VARCHAR NOT NULL,
	"usuario" VARCHAR NOT NULL UNIQUE,
	"senha_hash" VARCHAR NOT NULL,
	"alterar_senha" BOOLEAN NOT NULL DEFAULT FALSE,
	"id_funcao" INTEGER NOT NULL,
	"data_criacao" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
	"email" VARCHAR NOT NULL CHECK(email ~ '^.+@.+(.com(.br)?)$'),
	"email_verificado" BOOLEAN NOT NULL DEFAULT FALSE,
	PRIMARY KEY("id")
);




CREATE TABLE "funcoes" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"nome" VARCHAR NOT NULL,
	PRIMARY KEY("id")
);




CREATE TABLE "funcoes_permissoes" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"id_permissao" INTEGER NOT NULL,
	"id_funcao" INTEGER NOT NULL,
	PRIMARY KEY("id")
);




CREATE TABLE "permissoes" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"nome" VARCHAR NOT NULL,
	"descricao_log" VARCHAR NOT NULL,
	PRIMARY KEY("id")
);




CREATE TABLE "logs" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"id_permissao_utilizada" INTEGER NOT NULL,
	"id_usuario" INTEGER NOT NULL,
	"data" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
	PRIMARY KEY("id")
);




CREATE TABLE "logs_visualizados" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"id_log" INTEGER NOT NULL,
	"id_usuario" INTEGER NOT NULL,
	"data" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
	PRIMARY KEY("id")
);




CREATE TABLE "codigos_verificacao" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"codigo" VARCHAR(30) NOT NULL,
	"id_usuario" INTEGER NOT NULL,
	PRIMARY KEY("id")
);




CREATE TABLE "sessoes" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"id_usuario" INTEGER NOT NULL,
	"codigo" VARCHAR(60) NOT NULL,
	PRIMARY KEY("id")
);




CREATE TABLE "usuarios_bases" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"id_usuario" INTEGER NOT NULL,
	"id_base" INTEGER NOT NULL,
	PRIMARY KEY("id")
);

COMMENT ON TABLE "usuarios_bases" IS 'Essa tabela vai registrar os relacionamentos entre os usuários autorizados a interagir em auditorias e as bases com as quais esses usuários podem interagir.';


CREATE TABLE "status" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"nome" VARCHAR NOT NULL,
	"coloracao" VARCHAR(6) NOT NULL,
	PRIMARY KEY("id")
);




CREATE TABLE "areas_atuacao" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"nome" VARCHAR NOT NULL,
	PRIMARY KEY("id")
);




CREATE TABLE "grupos_responsabilidade" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"nome" VARCHAR NOT NULL,
	PRIMARY KEY("id")
);




CREATE TABLE "acoes_corretivas" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"nome" VARCHAR NOT NULL,
	PRIMARY KEY("id")
);




CREATE TABLE "acoes_corretivas_topicos" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"id_acao_corretivas" INTEGER NOT NULL,
	"id_topico" INTEGER NOT NULL,
	PRIMARY KEY("id")
);




CREATE TABLE "causas" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"nome" VARCHAR NOT NULL,
	PRIMARY KEY("id")
);




CREATE TABLE "topicos_causas" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"id_causa" INTEGER NOT NULL,
	"id_topico" INTEGER NOT NULL,
	PRIMARY KEY("id")
);




CREATE TABLE "solicitacoes_documentos" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"id_auditoria" INTEGER NOT NULL,
	"prazo" DATE NOT NULL,
	"id_usuario_solicitante" INTEGER NOT NULL,
	"id_questionamento" INTEGER NOT NULL,
	"data_criacao" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
	PRIMARY KEY("id")
);




CREATE TABLE "envios" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"id_solicitacao" INTEGER NOT NULL,
	"data_envio" DATE NOT NULL,
	"id_usuario" INTEGER NOT NULL,
	"id_status_envio" INTEGER NOT NULL,
	PRIMARY KEY("id")
);




CREATE TABLE "status_envio" (
	"id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
	"nome" VARCHAR NOT NULL,
	"coloracao" VARCHAR(6) NOT NULL,
	PRIMARY KEY("id")
);



ALTER TABLE "bases"
ADD FOREIGN KEY("id_gerente") REFERENCES "gerentes"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "bases"
ADD FOREIGN KEY("id_gerente_regional") REFERENCES "gerentes"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "bases"
ADD FOREIGN KEY("id_municipio") REFERENCES "municipios"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "municipios"
ADD FOREIGN KEY("id_estado") REFERENCES "estados"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "auditorias"
ADD FOREIGN KEY("id_base") REFERENCES "bases"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "topicos"
ADD FOREIGN KEY("id_auditoria") REFERENCES "auditorias"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "topicos"
ADD FOREIGN KEY("id_classificacao") REFERENCES "classificacoes"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "topicos"
ADD FOREIGN KEY("id_questionamento") REFERENCES "questionamentos"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "questionamentos"
ADD FOREIGN KEY("id_elemento") REFERENCES "elementos"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "elementos"
ADD FOREIGN KEY("id_modelo") REFERENCES "modelos"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "questionamentos"
ADD FOREIGN KEY("id_gravidade") REFERENCES "gravidades"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "questionamentos_normas"
ADD FOREIGN KEY("id_norma") REFERENCES "normas"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "questionamentos_normas"
ADD FOREIGN KEY("id_questionamento") REFERENCES "questionamentos"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "usuarios"
ADD FOREIGN KEY("id_funcao") REFERENCES "funcoes"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "funcoes_permissoes"
ADD FOREIGN KEY("id_funcao") REFERENCES "funcoes"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "funcoes_permissoes"
ADD FOREIGN KEY("id_permissao") REFERENCES "permissoes"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "logs"
ADD FOREIGN KEY("id_usuario") REFERENCES "usuarios"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "logs"
ADD FOREIGN KEY("id_permissao_utilizada") REFERENCES "permissoes"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "logs_visualizados"
ADD FOREIGN KEY("id_log") REFERENCES "logs"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "logs_visualizados"
ADD FOREIGN KEY("id_usuario") REFERENCES "usuarios"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "codigos_verificacao"
ADD FOREIGN KEY("id_usuario") REFERENCES "usuarios"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "sessoes"
ADD FOREIGN KEY("id_usuario") REFERENCES "usuarios"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "usuarios_bases"
ADD FOREIGN KEY("id_base") REFERENCES "bases"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "usuarios_bases"
ADD FOREIGN KEY("id_usuario") REFERENCES "usuarios"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "topicos"
ADD FOREIGN KEY("id_status") REFERENCES "status"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "topicos"
ADD FOREIGN KEY("id_area_atuacao") REFERENCES "areas_atuacao"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "topicos"
ADD FOREIGN KEY("id_grupo_responsavel") REFERENCES "grupos_responsabilidade"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "acoes_corretivas_topicos"
ADD FOREIGN KEY("id_acao_corretivas") REFERENCES "acoes_corretivas"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "acoes_corretivas_topicos"
ADD FOREIGN KEY("id_topico") REFERENCES "topicos"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "topicos_causas"
ADD FOREIGN KEY("id_causa") REFERENCES "causas"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "topicos_causas"
ADD FOREIGN KEY("id_topico") REFERENCES "topicos"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "solicitacoes_documentos"
ADD FOREIGN KEY("id_auditoria") REFERENCES "auditorias"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "solicitacoes_documentos"
ADD FOREIGN KEY("id_questionamento") REFERENCES "questionamentos"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "solicitacoes_documentos"
ADD FOREIGN KEY("id_usuario_solicitante") REFERENCES "usuarios"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "envios"
ADD FOREIGN KEY("id_solicitacao") REFERENCES "solicitacoes_documentos"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "envios"
ADD FOREIGN KEY("id_usuario") REFERENCES "usuarios"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE "envios"
ADD FOREIGN KEY("id_status_envio") REFERENCES "status_envio"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;